#!/usr/bin/env node

var input = process.argv.slice(2)[0],
    die = process.exit.bind(process);

if (!input) {
  console.log('usage: diff-sites FILE');
  die(1);
}

var fs = require('fs-extra'),
    path = require('path'),
    jsyaml = require('js-yaml'),
    spawn = require('child_process').spawn;

var buffer = fs.readFileSync(input).toString();

var sequence = jsyaml.safeLoad(buffer, { filename: input });

var builder = require('../lib/builder');

var jsonId = path.basename(input).replace(/\.\w+$/, '') + +(new Date()),
    jsonFile = path.join(process.cwd(), 'generated/' + jsonId + '.json');

fs.outputJsonSync(jsonFile, builder(sequence));

process.env.DIFF_JSON = jsonFile;
process.env.DIFF_LIB_DIR = path.join(__dirname, '../lib/casper');

var args = [];

// args.push('test');
args.push(path.join(__dirname, '../lib/casper/bootstrap.js'));

var child = spawn('casperjs', args);

child.stdout.on('data', function(data) {
  process.stdout.write(data.toString());
});

child.on('close', function(code) {
  die(code);
});
