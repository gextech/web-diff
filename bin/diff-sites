#!/usr/bin/env node

var input = process.argv.slice(2)[0],
    die = process.exit.bind(process);

if (!input) {
  throw new Error('missing input');
}

var fs = require('fs'),
    path = require('path'),
    jsyaml = require('js-yaml'),
    spawn = require('child_process').spawn;

var buffer = fs.readFileSync(input).toString();

var sequence = jsyaml.safeLoad(buffer, { filename: input });

var builder = require('../lib/builder');

var jsonFile = path.join(process.cwd(), 'data.js');

fs.writeFileSync(jsonFile, 'module.exports = ' + JSON.stringify({
  sequence: builder(sequence),
  libdir: path.join(__dirname, '../lib')
}) + ';');

var child = spawn('casperjs', [
  path.join(__dirname, '../lib/bootstrap.js'),
  '--ignore-ssl-errors=true'
]);

child.stdout.on('data', function(data) {
  process.stdout.write(data.toString());
});

child.on('close', function(code) {
  die(code);
});
